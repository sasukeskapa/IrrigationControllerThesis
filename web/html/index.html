<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <!--<link rel="stylesheet" type="text/css" href="sources/sasuStyle.css">-->
    <title>Irrigation Controller Web Client</title>
    <script type="text/javascript" src="jquery-3.2.1.min.js"></script>
  </head>
  <body>
<div align="center">
  <h1>Irrigation Controller Web Client</h1>

  <table align="center" style="border-collapse:collapse;text-align:center">
    <tr>  <th><div id=manualStopStatus><div/></th>  <th><button id="manualStopAllButton">Start/Stop Irrigation Switch</button></th>   </tr>
    <tr>  <th><div id=autoManualMode><div/></th>    <th><button id="modeChangeButton">Manual/Automatic Mode Switch</button></th>      </tr>
  </table>
  <br>
  <button id="unlockButton">Troubleshoot</button>

  <h2>Manual Program:</h2>
  </p>
  <table align="center" style="border-collapse:collapse;text-align:center">
    <tr> <th style="text-align:left;">Field:<th/>        <th>Valve list</th>    <th>Valve open time</th>  <th>Irrigation delta</th>  <th>Irrigation count</th>  <th>Activate button</th>  </tr>
    <tbody style="font-size:80%;">
    <tr> <th style="text-align:left;">Format:<th/>       <th>(n,n,n,n)</th>     <th>(hh:mm:ss)</th>       <th>(hh:mm:ss)</th>        <th>(n)</th>               <th>-</th>                </tr>
    <tr> <th style="text-align:left;">Example:<th/>      <th>1,3,4</th>         <th>00:00:02</th>         <th>00:30:00</th>          <th>5</th>                 <th>-</th>                </tr>
    <tr> <th style="text-align:left;">Explanation:<th/>  <th>Valve: 1,3,4</th>  <th>2 seconds</th>        <th>30 minutes</th>        <th>Run 5 times</th>       <th>-</th>                </tr>
    </tbody>
    <tr> <td style="text-align:left;">Program:<td/>
    <td><input type="text" id="manualValveList"/></td>          <td><input type="text" id="manualIrrigationTime"/></td>             <td><input type="text" id="manualIrrigationDelta"/></td>
    <td><input type="text" id="manualIrrigationCount"/></td>    <td><button id="manualUpload">Start Manual Program</button></td>
    </tr>
  </table>

  <h2>Automatic Program:</h2>
  <table align="center" style="border-collapse:collapse;text-align:center">
    <tr> <th style="text-align:left;">Field:<th/>       <th>Start time</th>  <th>End time</th>    <th>Valve list</th>   <th>Valve open time</th> <th>Irrigation delta</th> <th>Activate button</th> </tr>
    <tbody style="font-size:80%;">
    <tr> <th style="text-align:left;">Format:<th/>      <th>(hh:mm:ss)</th>  <th>(hh:mm:ss)</th>  <th>(n,n,n,n)</th>    <th>(hh:mm:ss)</th>      <th>(hh:mm:ss)</th>       <th>-</th>               </tr>
    <tr> <th style="text-align:left;">Example:<th/>     <th>08:00:00</th>    <th>20:00:00</th>    <th>1,2,4</th>        <th>00:00:02</th>        <th>00:30:00</th>         <th>-</th>               </tr>
    <tr> <th style="text-align:left;">Explanation:<th/> <th>08:00:00 AM</th> <th>08:00:00 PM</th> <th>Valve: 1,2,4</th> <th>2 seconds</th>       <th>30 minutes</th>       <th>-</th>               </tr>
    </tbody>
    <tr> <td style="text-align:left;">Program 1:<td/>
    <td><input type="text" id=      "starttime1"/></td>
    <td><input type="text" id=        "endtime1"/></td>
    <td><input type="text" id=      "valvelist1"/></td>
    <td><input type="text" id= "irrigationtime1"/></td>
    <td><input type="text" id="irrigationdelta1"/></td>
    <td><button        id="setirrigationbutton1">Set irrigation</button></td> </tr>
    <tr> <td style="text-align:left;">Program 2:<td/>
    <td><input type="text" id=      "starttime2"/></td>
    <td><input type="text" id=        "endtime2"/></td>
    <td><input type="text" id=      "valvelist2"/></td>
    <td><input type="text" id= "irrigationtime2"/></td>
    <td><input type="text" id="irrigationdelta2"/></td>
    <td><button        id="setirrigationbutton2">Set irrigation</button></td> </tr>
    <tr> <td style="text-align:left;">Program 3:<td/>
    <td><input type="text" id=      "starttime3"/></td>
    <td><input type="text" id=        "endtime3"/></td>
    <td><input type="text" id=      "valvelist3"/></td>
    <td><input type="text" id= "irrigationtime3"/></td>
    <td><input type="text" id="irrigationdelta3"/></td>
    <td><button        id="setirrigationbutton3">Set irrigation</button></td> </tr>
    <tr> <td style="text-align:left;">Program 4:<td/>
    <td><input type="text" id=      "starttime4"/></td>
    <td><input type="text" id=        "endtime4"/></td>
    <td><input type="text" id=      "valvelist4"/></td>
    <td><input type="text" id= "irrigationtime4"/></td>
    <td><input type="text" id="irrigationdelta4"/></td>
    <td><button        id="setirrigationbutton4">Set irrigation</button></td> </tr>
    <tr> <td style="text-align:left;">Program 5:<td/>
    <td><input type="text" id=      "starttime5"/></td>
    <td><input type="text" id=        "endtime5"/></td>
    <td><input type="text" id=      "valvelist5"/></td>
    <td><input type="text" id= "irrigationtime5"/></td>
    <td><input type="text" id="irrigationdelta5"/></td>
    <td><button        id="setirrigationbutton5">Set irrigation</button></td> </tr>
  </table>

<!--
  <p>First Pragraph.</p>
  <p> <input type="text" id="textfield1"/>  <button id="button1">Submit</button>  <button id="button2">JSON test</button>  <button id="button3">test</button>  <p/>
-->

  <p><div id=helloworld></div></p>
</div>

<!-- _____________________________________________________________________________________________________________________________________________________________________________________________________ -->

<script type="text/javascript">


//global variables
var stopAll = "0";
var autoManualMode = "0";
var lock = "0";
var modified = "0";
var timeRegex = new RegExp("^([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$");
var numberRegex = new RegExp("^\\d+$");
var valveListRegex = new RegExp("^(\\d+,)*\\d+$");
var autoprogramCount = 5;
var urlPrefix = "";


//functions
function setStopAllText() {
  if(stopAll == "0") $("#manualStopStatus").html("Irrigation is running.");
  else $("#manualStopStatus").html("Irrigation is STOPPED!");
}
function setAutoManualText() {
  if(autoManualMode == "0") $("#autoManualMode").html("Automatic mode.");
  else $("#autoManualMode").html("Manual mode.");
}
function lockConfigs() {
  //get lock value from server
  $.ajax({ type:"POST", url: urlPrefix + "lock.php", data:'empty=' + "", async: false, success: function(data){ lock = data; } });
  //wait until the configs files are unlocked
  while(lock != "0") { $.ajax({ type:"POST", url: urlPrefix + "lock.php", data:'empty=' + "", async: false, success: function(data){ lock = data; } }); }
  //lock the configs files
  while(lock != "1") { $.ajax({ type:"POST", url: urlPrefix + "lock.php", data:'lock=' + "1", async: false, success: function(data){ lock = data; }, }); }
}
function unlockConfigs() {
  //get lock value from server
  $.ajax({ type:"POST", url: urlPrefix + "lock.php", data:'empty=' + "", async: false, success: function(data){ lock = data; } });
  //unlock the configs files
  while(lock != "0") { $.ajax({ type:"POST", url: urlPrefix + "lock.php", data:'lock=' + "0", async: false, success: function(data){ lock = data; } }); }
}
function setModified() {
  modified = "0";
  while(modified != "1") { $.ajax({ type:"POST", url: urlPrefix + "modified.php", data:'modified=' + "1", async: false, success: function(data){ modified = data; } }); }
}


//document ready
$(document).ready(function(){
  $("#helloworld").html("Welcome!");                       //$("#textfield1").val("Hello World!");

  $("#manualValveList").val(         "1,2,4");             $("#manualIrrigationTime").val("00:00:01");
  $("#manualIrrigationDelta").val("00:00:04");             $("#manualIrrigationCount").val("2");

  for (i = 1; i <= autoprogramCount; i++) {
    $(      "#starttime" + i).val("08:00:00");
    $(        "#endtime" + i).val("08:00:00");
    $(      "#valvelist" + i).val("1,2,4");
    $( "#irrigationtime" + i).val("00:00:10");
    $("#irrigationdelta" + i).val("00:01:00");
  }

  //getting the stop value _____________________________________________________________________________________________________________________________________________________________________
  $.ajax({ type:"POST", url: urlPrefix + "manual_stop.php", data:'empty=' + "",
           success: function(data){ stopAll = data; setStopAllText(); }
  });
  //getting mode value
  $.ajax({ type:"POST", url: urlPrefix + "mode_switcher.php", data:'empty=' + "",
           success: function(data){ autoManualMode = data; setAutoManualText(); }
  });
  //getting manual program values
  $.ajax({ type:"POST", url: urlPrefix + "manual1.php", data:'get=' + "",
           success: function(data){
                var jsonObj = jQuery.parseJSON( data );
                $(      "#manualValveList").val(jsonObj.valvelist);
                $( "#manualIrrigationTime").val(jsonObj.irrigationtime);
                $("#manualIrrigationDelta").val(jsonObj.irrigationdelta);
                $("#manualIrrigationCount").val(jsonObj.irrigationcount);
           }
  });
  //getting automatic program values
  for (i = 1; i <= autoprogramCount; i++) (function(i){
    var dataGet = "get" + i + "=";
    $.ajax({ type:"POST", url: urlPrefix + "auto1.php", data: dataGet,
             success: function(data){
                  var jsonObj = jQuery.parseJSON( data );
                  $(      "#starttime" + i).val(jsonObj.starttime);
                  $(        "#endtime" + i).val(jsonObj.endtime);
                  $(      "#valvelist" + i).val(jsonObj.valvelist);
                  $( "#irrigationtime" + i).val(jsonObj.irrigationtime);
                  $("#irrigationdelta" + i).val(jsonObj.irrigationdelta);
             }
    });
  })(i);
});


//Testing section _____________________________________________________________________________________________________________________________________________________________________
//$("#button1").click( function(){
//  $("#helloworld").html($("#textfield1").val());
//});
//$("#button2").click( function(){
//  var myObject = new Object();
//  myObject.name = "John";
//  myObject.age  = 12;
//  myObject.pets = ["cat", "dog"];
//  var myString = JSON.stringify(myObject);
//  $("#helloworld").html(myString);
//});
//$("#button3").click( function(){
//  setModified();
//  $("#helloworld").html(modified);
//});


//MANUAL PART _____________________________________________________________________________________________________________________________________________________________________
$("#manualStopAllButton").click( function(){
  $("#helloworld").html("Manual Stop All!!!");
  if(stopAll == "0") stopAll = "1"; else stopAll = "0";
  //lock config files
  lockConfigs();
  //sending the stop signal
  $.ajax({ type:"POST", url: urlPrefix + "manual_stop.php", data:'stop=' + stopAll, async: false, success: function(data){ stopAll = data; setStopAllText(); } });
  //set modified file
  setModified();
  //unlock config files
  unlockConfigs();
});
$("#modeChangeButton").click( function(){
  $("#helloworld").html("Mode switch!");
  if(autoManualMode == "0") autoManualMode = "1"; else autoManualMode = "0";
  //lock config files
  lockConfigs();
  //sending the mode signal
  $.ajax({ type:"POST", url: urlPrefix + "mode_switcher.php", data:'mode=' + autoManualMode, async: false,
           success: function(data){ autoManualMode = data; setAutoManualText(); }
  });
  //set modified file
  setModified();
  //unlock config files
  unlockConfigs();
});
$("#manualUpload").click( function(){
  //creating the json object
  var irrigationSet = new Object();
  irrigationSet.valvelist       = $(      "#manualValveList").val();
  irrigationSet.irrigationtime  = $( "#manualIrrigationTime").val();
  irrigationSet.irrigationdelta = $("#manualIrrigationDelta").val();
  irrigationSet.irrigationcount = $("#manualIrrigationCount").val();
  $(      "#manualValveList").css("background-color","white");
  $( "#manualIrrigationTime").css("background-color","white");
  $("#manualIrrigationDelta").css("background-color","white");
  $("#manualIrrigationCount").css("background-color","white");
  var error = false;
  if (!valveListRegex.test(irrigationSet.valvelist)){
    error = true;
    $(      "#manualValveList").css("background-color","red");
    alert("The Manual Valve List is not valid.\nPlease consult the Format, Example and Explanation fields again.");
  }
  if (!timeRegex.test(irrigationSet.irrigationtime)){
    error = true;
    $( "#manualIrrigationTime").css("background-color","red");
    alert("The Manual Irrigation Time is not valid.\nPlease consult the Format, Example and Explanation fields again.");
  }
  if (!timeRegex.test(irrigationSet.irrigationdelta)){
    error = true;
    $("#manualIrrigationDelta").css("background-color","red");
    alert("The Manual Irrigation Delta is not valid.\nPlease consult the Format, Example and Explanation fields again.");
  }
  if (!numberRegex.test(irrigationSet.irrigationcount)){
    error = true;
    $("#manualIrrigationCount").css("background-color","red");
    alert("The Manual Irrigation Count is not valid.\nPlease consult the Format, Example and Explanation fields again.");
  }
  if(!error){
    var jsonString = JSON.stringify(irrigationSet);
    $("#helloworld").html(jsonString);
    //lock config files
    lockConfigs();
    //sending the json
    $.ajax({ type:"POST", url: urlPrefix + "manual1.php", data:'json=' + jsonString, async: false, //dataType:'json',
             success: function(){ $("#helloworld").html("Manual upload worked!!!"); }
    });
    //switching to manual mode
    $.ajax({ type:"POST", url: urlPrefix + "mode_switcher.php", data:'mode=' + "1", async: false,
             success: function(data){ autoManualMode = data; setAutoManualText(); }
    });
    //set modified file
    setModified();
    //unlock config files
    unlockConfigs();
  }
});


//TROUBLESHOOT _____________________________________________________________________________________________________________________________________________________________________
$("#unlockButton").click( function(){
  //unlock config files
  unlockConfigs();
  $("#helloworld").html("Problems solved.");
});


//AUTOMATIC PART _____________________________________________________________________________________________________________________________________________________________________
for (i = 1; i <= autoprogramCount; i++) (function(i){
  $("#setirrigationbutton" + i).click( function(){
    var irrigationSet = new Object();
    irrigationSet.starttime       = $(      "#starttime" + i).val();
    irrigationSet.endtime         = $(        "#endtime" + i).val();
    irrigationSet.valvelist       = $(      "#valvelist" + i).val();//["cat", "dog"];
    irrigationSet.irrigationtime  = $( "#irrigationtime" + i).val();
    irrigationSet.irrigationdelta = $("#irrigationdelta" + i).val();
    $(      "#starttime" + i).css("background-color","white");
    $(        "#endtime" + i).css("background-color","white");
    $(      "#valvelist" + i).css("background-color","white");
    $( "#irrigationtime" + i).css("background-color","white");
    $("#irrigationdelta" + i).css("background-color","white");
    var error = false;
    if (!valveListRegex.test(irrigationSet.valvelist)){
      error = true;
      $(      "#valvelist" + i).css("background-color","red");
      alert("The Auto Program " + i + " Valve List is not valid.\nPlease consult the Format, Example and Explanation fields again.");
    }
    if (!timeRegex.test(irrigationSet.starttime)){
      error = true;
      $( "#starttime" + i).css("background-color","red");
      alert("The Auto Program " + i + " Start Time is not valid.\nPlease consult the Format, Example and Explanation fields again.");
    }
    if (!timeRegex.test(irrigationSet.endtime)){
      error = true;
      $("#endtime" + i).css("background-color","red");
      alert("The Auto Program " + i + " End Time is not valid.\nPlease consult the Format, Example and Explanation fields again.");
    }
    if (!timeRegex.test(irrigationSet.irrigationtime)){
      error = true;
      $( "#irrigationtime" + i).css("background-color","red");
      alert("The Auto Program " + i + " Irrigation Time is not valid.\nPlease consult the Format, Example and Explanation fields again.");
    }
    if (!timeRegex.test(irrigationSet.irrigationdelta)){
      error = true;
      $("#irrigationdelta" + i).css("background-color","red");
      alert("The Auto Program " + i + " Irrigation Delta is not valid.\nPlease consult the Format, Example and Explanation fields again.");
    }
    if(!error){
      var jsonString = JSON.stringify(irrigationSet);
      $("#helloworld").html(jsonString);
      //lock config files
      lockConfigs();
      //sending the json
      var dataGet = "json" + i + "=" + jsonString;
      $.ajax({ type:"POST", url: urlPrefix + "auto1.php", data: dataGet, async: false, //dataType:'json',
               success: function(){ $("#helloworld").html("Automated program " + i + " upload worked!!!"); }
      });
      //set modified file
      setModified();
      //unlock config files
      unlockConfigs();
    }
  });
})(i);


</script>

<?php
  //print PHP info
  //phpinfo();
?>

  </body>
</html>
